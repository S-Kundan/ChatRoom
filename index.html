 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Chat - Hidden Reply Mode</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1e1e1e; color: white; margin: 0; padding: 10px; overflow-x: hidden; }
        #chatbox { height: 65vh; overflow-y: auto; background: #2b2b2b; padding: 10px; border-radius: 10px; position: relative; z-index: 1; }
        
        .msg-wrapper { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 8px; }
        .msg { padding: 8px 12px; background: #3b3b3b; border-radius: 8px; flex-grow: 1; word-break: break-word; position: relative; }
        
        .username { font-weight: bold; margin-right: 6px; color: #81d4fa; display: inline-block; }
        .timestamp { display: block; font-size: 10px; color: #aaa; text-align: right; margin-top: 4px; }
        .seen-count { font-size: 10px; color: #4caf50; margin-left: 8px; display: inline-flex; align-items: center; float: right; margin-top: 4px; margin-right: 5px; }
        
        /* Buttons */
        .delete-btn { width: 28px; height: 28px; background: #aaa; border: none; border-radius: 50%; cursor: pointer; margin-left: 6px; margin-top: 5px; flex-shrink: 0; }
        .reply-btn { 
            width: 28px; height: 28px; background: #4fc3f7; border: none; 
            border-radius: 50%; cursor: pointer; margin-left: 6px; margin-top: 5px; 
            color: black; font-weight: bold; font-size: 16px; display: flex; 
            align-items: center; justify-content: center; flex-shrink: 0;
        }

        /* Input Area */
        #message { flex-grow: 1; padding: 10px; background-color: black; color: #222222; border-radius: 20px; border: none; outline: none; z-index: 2; }
        #controls { display: flex; align-items: center; margin-top: 0px; position: relative; z-index: 2; }
        #upload { background: transparent; border: none; font-size: 18px; cursor: pointer; margin-left: -35px; z-index: 5; }
        #send { width: 40px; height: 40px; background: #4caf50; border: none; border-radius: 50%; margin-left: 10px; cursor: pointer; flex-shrink: 0; }
        #clearBtn { width: 40px; height: 40px; background: red; border: none; border-radius: 50%; margin-right: 10px; cursor: pointer; flex-shrink: 0; }
        
        /* Reply Preview (Above Input) */
        #replyPreview {
            display: none; 
            background: #2b2b2b;
            border-left: 4px solid #4caf50;
            padding: 8px 12px;
            margin-bottom: 5px;
            margin-top: 10px;
            border-radius: 5px;
            position: relative;
            font-size: 12px;
            color: #ccc;
        }
        #replyPreview strong { color: #81d4fa; display: block; margin-bottom: 2px; }
        #closeReply { 
            position: absolute; right: 10px; top: 5px; 
            color: #ff5252; cursor: pointer; font-weight: bold; font-size: 14px; 
        }

        /* Quoted Message in Chat */
        .quoted-msg {
            border-left: 3px solid #81d4fa;
            background: rgba(0, 0, 0, 0.3);
            padding: 5px 8px;
            border-radius: 4px;
            margin-bottom: 6px;
            font-size: 11px;
            color: #bbb;
            display: block;
            width: fit-content;
            max-width: 100%;
        }
        .quoted-name { color: #81d4fa; font-weight: bold; display: block; margin-bottom: 2px;}

        #decodeBtn { 
            position: fixed; bottom: 10px; left: 10px; width: 50px; height: 50px; 
            background: #1e1e1e; border-radius: 50%; border: none; z-index: 1000; 
            display: none; cursor: pointer; outline: none;
        }
        
        #overlay, #nameOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000a; color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; }
        #userList { margin-top: 10px; font-size: 14px; color: lightgreen; }

        .rocket {
            position: fixed; bottom: 60px; font-size: 30px; pointer-events: none; z-index: 9999;
            animation: fly 1.5s ease-out forwards;
        }

        @keyframes fly {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            50% { opacity: 1; }
            100% { transform: translateY(-80vh) scale(0.5); opacity: 0; }
        }
    </style>
</head>
<body>

    <div id="overlay">
        <h3>Enter Room Password</h3>
        <input type="password" id="roomPass" placeholder="">
        <button onclick="checkPassword()" style="margin-top:10px;">Enter</button>
    </div>

    <div id="nameOverlay" style="display: none;">
        <h3>Enter Your Name</h3>
        <input type="text" id="username" placeholder="">
        <button onclick="saveUsername()" style="margin-top:10px;">Start</button>
    </div>

    <div id="chatbox"></div>
    <div id="userList">Active Users: <span id="activeUsers"></span></div>

    <div style="position: relative; z-index: 2;">
        <div id="replyPreview">
            <span id="closeReply" onclick="cancelReply()">‚úñ</span>
            <strong id="replyToName">Replying to...</strong>
            <span id="replyTextPreview">Message...</span>
        </div>

        <div id="controls">
            <button id="clearBtn" onclick="clearChat()"></button>
            <input type="text" id="message" placeholder="">
            <input type="file" id="fileInput" hidden>
            <button id="upload">üìé</button>
            <button id="send"></button>
        </div>
    </div>

    <button id="decodeBtn"></button>
    <audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2869ew.mp3" hidden></audio>

    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyCbQLA5TlFk3zcNoRwLVDMRS0M_WT9uXkQ", 
            authDomain: "chat-karona.firebaseapp.com", 
            databaseURL: "https://chat-karona-default-rtdb.firebaseio.com", 
            projectId: "chat-karona", 
            storageBucket: "chat-karona.firebasestorage.app", 
            messagingSenderId: "74516798409", 
            appId: "1:74516798409:web:7c7ed192a5ac64ad466618", 
            measurementId: "G-36HW4WQ5P5" 
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const storage = firebase.storage();
        const chatRef = db.ref("messages");
        const usersRef = db.ref("activeUsers");

        let currentUser = "";
        let decodeHeld = false;
        let lastUpdateId = 0; 
        
        // --- REPLY STATE VARIABLES ---
        let replyingTo = null;

        const TELEGRAM_BOT_TOKEN = "8228342717:AAG5e-0MUyvY5ZkWbg_bTYHDEVFkZCdASiI"; 
        const TELEGRAM_CHAT_ID = "1664362316";

        // --- REPLY FUNCTIONS ---
        function initiateReply(name, text) {
            replyingTo = { name: name, text: text };
            document.getElementById("replyPreview").style.display = "block";
            document.getElementById("replyToName").textContent = "Replying to " + name;
            
            // Preview text (No HTML tags)
            let cleanText = text.replace(/<[^>]*>?/gm, ''); 
            if(cleanText.length > 50) cleanText = cleanText.substring(0, 50) + "...";
            document.getElementById("replyTextPreview").textContent = cleanText;
            
            document.getElementById("message").focus();
        }

        function cancelReply() {
            replyingTo = null;
            document.getElementById("replyPreview").style.display = "none";
        }

        function sendTelegramLoginAlert(name) {
            const msg = `üö® *New Login*\nüë§ User: ${name}`;
            const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${encodeURIComponent(msg)}&parse_mode=Markdown`;
            fetch(url).catch(e => console.error(e));
        }

        function forwardToTelegram(name, text) {
            const msg = `üí¨ *${name}:* ${text}`;
            const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${encodeURIComponent(msg)}&parse_mode=Markdown`;
            fetch(url).catch(e => console.error(e));
        }

        function startTelegramListener() {
            setInterval(() => {
                const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getUpdates?offset=${lastUpdateId + 1}`;
                fetch(url).then(res => res.json()).then(data => {
                    if (data.result && data.result.length > 0) {
                        data.result.forEach(update => {
                            lastUpdateId = update.update_id;
                            if (update.message && update.message.text && String(update.message.chat.id) === TELEGRAM_CHAT_ID) {
                                const text = update.message.text;
                                if(text !== "/start") pushAdminMessage(text);
                            }
                        });
                    }
                }).catch(err => console.log("Polling error (ignore):", err));
            }, 3000); 
        }

        function pushAdminMessage(text) {
            const now = new Date();
            const timeString = now.toLocaleDateString() + " " + now.toLocaleTimeString('en-US', {hour: 'numeric', minute:'2-digit', hour12: true});
            chatRef.push({ name: "KK", encoded: "         ", original: text, time: timeString, views: 0 });
            launchRocket();
        }

        function checkPassword() {
            const pass = document.getElementById("roomPass").value;
            if (pass === "1252") {
                document.getElementById("overlay").style.display = "none";
                document.getElementById("nameOverlay").style.display = "flex";
            } else {
                alert("Wrong password!");
            }
        }

        function saveUsername() {
            const nameInput = document.getElementById("username");
            const name = nameInput.value.trim();
            if (name) {
                currentUser = name;
                document.getElementById("nameOverlay").style.display = "none";
                document.getElementById("decodeBtn").style.display = "block";
                
                usersRef.child(name).set(true);
                usersRef.child(name).onDisconnect().remove();
                sendTelegramLoginAlert(name);
                startTelegramListener(); 
            } else {
                alert("Enter your name!");
            }
        }

        usersRef.on("value", snap => {
            const users = snap.val() || {};
            document.getElementById("activeUsers").textContent = Object.keys(users).join(", ");
        });

        function launchRocket() {
            const rocket = document.createElement("div");
            rocket.innerText = "üöÄ";
            rocket.className = "rocket";
            rocket.style.left = (Math.random() * window.innerWidth) + "px";
            document.body.appendChild(rocket);
            setTimeout(() => { rocket.remove(); }, 1500);
        }

        document.getElementById("message").addEventListener("input", () => launchRocket());
        document.getElementById("send").onclick = sendMessage;
        document.getElementById("message").addEventListener("keypress", (e) => { if (e.key === "Enter") { e.preventDefault(); sendMessage(); } });

        // --- UPDATED SEND MESSAGE (Hidden Reply + Link Visible) ---
        function sendMessage() {
            let real = document.getElementById("message").value.trim();
            if (!real || !currentUser) return;

            let telegramText = real; 
            let finalEncoded = "         "; 
            let finalOriginal = real;

            // Link Detection
            const linkPattern = /((https?:\/\/)|(www\.)|[a-zA-Z0-9-]+\.(com|net|org|in|co|us|gov|edu|info|io))/i;
            const hasLink = linkPattern.test(real);
            const hasEmail = /\S+@\S+\.\S+/.test(real);
            const isVisibleContent = hasLink || hasEmail; 

            // Reply Logic
            if (replyingTo) {
                // Original (Full Text for Decode)
                const quoteHTML_Real = `<div class="quoted-msg"><span class="quoted-name">${replyingTo.name}</span>${replyingTo.text}</div>`;
                finalOriginal = quoteHTML_Real + real;
                
                // Encoded (Hidden Text) -> Quote mein sirf "..."
                const quoteHTML_Hidden = `<div class="quoted-msg"><span class="quoted-name">${replyingTo.name}</span> ... </div>`; 
                
                if (isVisibleContent) {
                    finalEncoded = quoteHTML_Hidden + real; // Link hai to dikhao
                } else {
                    finalEncoded = quoteHTML_Hidden + "         "; // Text hai to blank
                }
                
                telegramText = `[Replying to ${replyingTo.name}: "${replyingTo.text}"]\n${real}`;
                cancelReply(); 
            } else {
                // Normal Logic
                if (isVisibleContent) {
                    finalEncoded = real;
                }
            }

            const now = new Date();
            const timeString = now.toLocaleDateString() + " " + now.toLocaleTimeString('en-US', {hour: 'numeric', minute:'2-digit', hour12: true});

            chatRef.push({ 
                name: currentUser, 
                encoded: finalEncoded, 
                original: finalOriginal, 
                time: timeString, 
                views: 0 
            });

            forwardToTelegram(currentUser, telegramText);
            document.getElementById("message").value = "";
            launchRocket();
        }

        chatRef.on("child_added", snap => {
            const data = snap.val();
            const msgKey = snap.key;
            const wrapper = document.createElement("div");
            wrapper.className = "msg-wrapper";
            wrapper.id = "msg-" + msgKey;

            const msgDiv = document.createElement("div");
            msgDiv.className = "msg";
            
            const nameSpan = document.createElement("span");
            nameSpan.className = "username";
            nameSpan.textContent = `[${data.name}] `;
            
            msgDiv.dataset.original = data.original;
            msgDiv.dataset.encoded = data.encoded;
            msgDiv.dataset.time = data.time || ""; 

            msgDiv.prepend(nameSpan);

            const contentSpan = document.createElement("span");
            contentSpan.innerHTML = " " + linkify(decodeHeld ? data.original : data.encoded);
            msgDiv.appendChild(contentSpan);

            const seenSpan = document.createElement("span");
            seenSpan.className = "seen-count";
            seenSpan.id = "seen-" + msgKey;
            seenSpan.textContent = `üëÅÔ∏è ${data.views || 0}`;
            msgDiv.appendChild(seenSpan);

            const timeSpan = document.createElement("span");
            timeSpan.className = "timestamp";
            timeSpan.textContent = data.time || "";
            msgDiv.appendChild(timeSpan);

            const deleteBtn = document.createElement("button");
            deleteBtn.className = "delete-btn";
            deleteBtn.onclick = () => {
                const pass = prompt("Enter admin delete code or your name to delete:");
                if (pass === "1234" || pass === data.name) snap.ref.remove(); 
            };

            // NEW: Reply Button
            const replyBtn = document.createElement("button");
            replyBtn.className = "reply-btn";
            replyBtn.innerHTML = "‚Ü©Ô∏è"; 
            replyBtn.onclick = () => {
                // Strip HTML tags for cleaner quote
                let rawText = data.original.replace(/<[^>]*>?/gm, ' ').trim();
                if(rawText === "") rawText = "FILE / IMAGE";
                initiateReply(data.name, rawText);
            };

            wrapper.appendChild(replyBtn);
            wrapper.appendChild(deleteBtn);
            wrapper.appendChild(msgDiv);
            document.getElementById("chatbox").appendChild(wrapper);
            
            const chatbox = document.getElementById("chatbox");
            chatbox.scrollTop = chatbox.scrollHeight;

            const hasSeen = localStorage.getItem("seen_" + msgKey);
            if (!hasSeen && data.name !== currentUser) {
                snap.ref.child("views").transaction((v) => (v || 0) + 1);
                localStorage.setItem("seen_" + msgKey, "true");
            }

            const sound = document.getElementById("notifSound");
            if (sound) { sound.volume = 1.0; sound.currentTime = 0; sound.play().catch(e => {}); }
        });

        chatRef.on("child_changed", snap => {
            const data = snap.val();
            const msgKey = snap.key;
            const msgDiv = document.querySelector(`#msg-${msgKey} .msg`);
            if (msgDiv) {
                msgDiv.dataset.original = data.original;
                msgDiv.dataset.encoded = data.encoded;
                
                const seenSpan = document.getElementById("seen-" + msgKey);
                if (seenSpan) seenSpan.textContent = `üëÅÔ∏è ${data.views || 0}`;
                if (decodeHeld) updateMessages(true);
            }
        });

        chatRef.on("child_removed", snap => {
            const wrapper = document.getElementById("msg-" + snap.key);
            if (wrapper) wrapper.remove();
        });

        function clearChat() {
            const pass = prompt("Enter admin delete code:");
            if (pass === "1234") {
                chatRef.remove();
                document.getElementById("chatbox").innerHTML = "";
            }
        }

        document.getElementById("upload").onclick = () => document.getElementById("fileInput").click();
        document.getElementById("fileInput").onchange = e => {
            const file = e.target.files[0];
            if (!file || !currentUser) return;
            const filePath = `uploads/${Date.now()}_${file.name}`;
            storage.ref(filePath).put(file).then(snapshot => {
                snapshot.ref.getDownloadURL().then(url => {
                    const isImage = file.type.startsWith("image/");
                    const encoded = "üöÄ üìÅ"; 
                    const original = isImage ? `<img src="${url}" style="max-width:200px;">` : `<a href="${url}" target="_blank">${file.name}</a>`;
                    const now = new Date();
                    const timeString = now.toLocaleDateString() + " " + now.toLocaleTimeString('en-US', {hour: 'numeric', minute:'2-digit', hour12: true});
                    chatRef.push({ name: currentUser, encoded, original, time: timeString, views: 0 });
                    forwardToTelegram(currentUser, `Sent a file: ${file.name}`);
                    launchRocket();
                });
            }).catch(error => alert("Upload failed: " + error.message));
        };

        function updateMessages(showOriginal) {
            document.querySelectorAll(".msg").forEach(msg => {
                const username = msg.querySelector(".username");
                const timeText = msg.dataset.time || ""; 
                const seenCount = msg.querySelector(".seen-count"); 

                msg.innerHTML = ""; 
                if(username) msg.appendChild(username); 
                
                const textToShow = showOriginal ? msg.dataset.original : msg.dataset.encoded;
                
                const contentSpan = document.createElement("span");
                contentSpan.innerHTML = " " + linkify(textToShow);
                msg.appendChild(contentSpan);

                if(seenCount) msg.appendChild(seenCount);
                const timeSpan = document.createElement("span");
                timeSpan.className = "timestamp";
                timeSpan.textContent = timeText;
                msg.appendChild(timeSpan);
            });
        }

        const decodeBtn = document.getElementById("decodeBtn");
        decodeBtn.onmousedown = decodeBtn.ontouchstart = () => { decodeHeld = true; updateMessages(true); };
        decodeBtn.onmouseup = decodeBtn.ontouchend = () => { decodeHeld = false; updateMessages(false); };

        function linkify(text) {
            var urlRegex = /((https?:\/\/)|(www\.)|[a-zA-Z0-9-]+\.(com|net|org|in|co|us|gov|edu|info|io))([-a-zA-Z0-9+&@#\/%?=~_|!:,.;]*)/ig;
            var mailRegex = /(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim;
            return text.replace(urlRegex, function(url) {
                let href = url;
                if (!url.toLowerCase().startsWith("http") && !url.toLowerCase().startsWith("ftp")) href = "http://" + url;
                return '<a href="' + href + '" target="_blank" style="color: #4fc3f7; text-decoration: underline;">' + url + '</a>';
            }).replace(mailRegex, '<a href="mailto:$1" style="color: #4fc3f7; text-decoration: underline;">$1</a>');
        }
    </script>
</body>
</html>

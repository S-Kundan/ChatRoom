<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Chat - Sound Fixed</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1e1e1e; color: white; margin: 0; padding: 10px; overflow-x: hidden; }
        #chatbox { height: 65vh; overflow-y: auto; background: #2b2b2b; padding: 10px; border-radius: 10px; position: relative; z-index: 1; }
        .msg-wrapper { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 8px; }
        .msg { padding: 8px 12px; background: #3b3b3b; border-radius: 8px; flex-grow: 1; word-break: break-word; position: relative; }
        .username { font-weight: bold; margin-right: 6px; color: #81d4fa; }
        
        .timestamp { display: block; font-size: 10px; color: #aaa; text-align: right; margin-top: 4px; }
        
        .seen-count { font-size: 10px; color: #4caf50; margin-left: 8px; display: inline-flex; align-items: center; float: right; margin-top: 4px; margin-right: 5px; }
        
        .delete-btn { width: 28px; height: 28px; background: #aaa; border: none; border-radius: 50%; cursor: pointer; margin-left: 6px; margin-top: 5px; }
        
        #message { flex-grow: 1; padding: 10px; background-color: black; color: black; border-radius: 20px; border: none; outline: none; z-index: 2; }
        
        #controls { display: flex; align-items: center; margin-top: 10px; position: relative; z-index: 2; }
        #upload { background: transparent; border: none; font-size: 18px; cursor: pointer; margin-left: -35px; z-index: 5; }
        
        #send { width: 40px; height: 40px; background: #4caf50; border: none; border-radius: 50%; margin-left: 10px; cursor: pointer; flex-shrink: 0; }
        #clearBtn { width: 40px; height: 40px; background: red; border: none; border-radius: 50%; margin-right: 10px; cursor: pointer; flex-shrink: 0; }
        
        #decodeBtn { position: fixed; bottom: 10px; left: 10px; width: 50px; height: 50px; background:#1e1e1e; border-radius: 50%; border: none; z-index: 1000; }
        #overlay, #nameOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000a; color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; }
        
        #userList { margin-top: 10px; font-size: 14px; color: lightgreen; }

        .rocket {
            position: fixed;
            bottom: 60px;
            font-size: 30px;
            pointer-events: none; 
            z-index: 9999;
            animation: fly 1.5s ease-out forwards;
        }

        @keyframes fly {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            50% { opacity: 1; }
            100% { transform: translateY(-80vh) scale(0.5); opacity: 0; }
        }
    </style>
</head>
<body>

    <div id="overlay">
        <h3>Enter Room Password</h3>
        <input type="password" id="roomPass" placeholder="">
        <button onclick="checkPassword()" style="margin-top:10px;">Enter</button>
    </div>

    <div id="nameOverlay" style="display: none;">
        <h3>Enter Your Name</h3>
        <input type="text" id="username" placeholder="">
        <button onclick="saveUsername()" style="margin-top:10px;">Start</button>
    </div>

    <div id="chatbox"></div>
    <div id="userList">Active Users: <span id="activeUsers"></span></div>

    <div id="controls">
        <button id="clearBtn" onclick="clearChat()"></button>
        <input type="text" id="message" placeholder="">
        <input type="file" id="fileInput" hidden>
        <button id="upload">üìé</button>
        <button id="send"></button>
    </div>

    <button id="decodeBtn"></button>
    
    <audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2869ew.mp3" hidden></audio>

    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyCbQLA5TlFk3zcNoRwLVDMRS0M_WT9uXkQ", 
            authDomain: "chat-karona.firebaseapp.com", 
            databaseURL: "https://chat-karona-default-rtdb.firebaseio.com", 
            projectId: "chat-karona", 
            storageBucket: "chat-karona.firebasestorage.app", 
            messagingSenderId: "74516798409", 
            appId: "1:74516798409:web:7c7ed192a5ac64ad466618", 
            measurementId: "G-36HW4WQ5P5" 
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const storage = firebase.storage();
        const chatRef = db.ref("messages");
        const usersRef = db.ref("activeUsers");

        let currentUser = "";
        let decodeHeld = false;

        function checkPassword() {
            const pass = document.getElementById("roomPass").value;
            if (pass === "1252") {
                document.getElementById("overlay").style.display = "none";
                document.getElementById("nameOverlay").style.display = "flex";
            } else {
                alert("Wrong password!");
            }
        }

        function saveUsername() {
            const nameInput = document.getElementById("username");
            const name = nameInput.value.trim();
            if (name) {
                currentUser = name;
                document.getElementById("nameOverlay").style.display = "none";
                usersRef.child(name).set(true);
                usersRef.child(name).onDisconnect().remove();
            } else {
                alert("Enter your name!");
            }
        }

        usersRef.on("value", snap => {
            const users = snap.val() || {};
            const list = Object.keys(users).join(", ");
            document.getElementById("activeUsers").textContent = list;
        });

        function launchRocket() {
            const rocket = document.createElement("div");
            rocket.innerText = "üöÄ";
            rocket.className = "rocket";
            const randomLeft = Math.random() * window.innerWidth;
            rocket.style.left = randomLeft + "px";
            document.body.appendChild(rocket);
            setTimeout(() => { rocket.remove(); }, 1500);
        }

        document.getElementById("message").addEventListener("input", function() {
            launchRocket();
        });

        document.getElementById("send").onclick = sendMessage;
        document.getElementById("message").addEventListener("keypress", function(event) {
            if (event.key === "Enter") { event.preventDefault(); sendMessage(); }
        });

        function sendMessage() {
            const real = document.getElementById("message").value.trim();
            if (!real || !currentUser) return;
            
            const encoded = "üöÄ üöÄ üöÄ";
            const now = new Date();
            const timeString = now.toLocaleDateString() + " " + now.toLocaleTimeString('en-US', {hour: 'numeric', minute:'2-digit', hour12: true});

            chatRef.push({ 
                name: currentUser, 
                encoded, 
                original: real,
                time: timeString,
                views: 0
            });
            document.getElementById("message").value = "";
            launchRocket();
        }

        chatRef.on("child_added", snap => {
            const data = snap.val();
            const msgKey = snap.key;

            const wrapper = document.createElement("div");
            wrapper.className = "msg-wrapper";
            wrapper.id = "msg-" + msgKey;

            const msgDiv = document.createElement("div");
            msgDiv.className = "msg";
            
            const nameSpan = document.createElement("span");
            nameSpan.className = "username";
            nameSpan.textContent = `[${data.name}] `;
            
            msgDiv.dataset.original = data.original;
            msgDiv.dataset.encoded = data.encoded;
            msgDiv.dataset.time = data.time || ""; 

            msgDiv.prepend(nameSpan);
            msgDiv.append(" " + (decodeHeld ? data.original : data.encoded));

            const seenSpan = document.createElement("span");
            seenSpan.className = "seen-count";
            seenSpan.id = "seen-" + msgKey;
            seenSpan.textContent = `üëÅÔ∏è ${data.views || 0}`;
            msgDiv.appendChild(seenSpan);

            const timeSpan = document.createElement("span");
            timeSpan.className = "timestamp";
            timeSpan.textContent = data.time || "";
            msgDiv.appendChild(timeSpan);

            const deleteBtn = document.createElement("button");
            deleteBtn.className = "delete-btn";
            deleteBtn.onclick = () => {
                const pass = prompt("Enter admin delete code or your name to delete:");
                if (pass === "1234" || pass === data.name) {
                    snap.ref.remove(); 
                }
            };

            wrapper.appendChild(deleteBtn);
            wrapper.appendChild(msgDiv);
            document.getElementById("chatbox").appendChild(wrapper);
            
            const chatbox = document.getElementById("chatbox");
            chatbox.scrollTop = chatbox.scrollHeight;

            const hasSeen = localStorage.getItem("seen_" + msgKey);
            if (!hasSeen && data.name !== currentUser) {
                snap.ref.child("views").transaction((currentViews) => {
                    return (currentViews || 0) + 1;
                });
                localStorage.setItem("seen_" + msgKey, "true");
            }

            // --- IMPROVED SOUND PLAYBACK ---
            const sound = document.getElementById("notifSound");
            if (sound) { 
                sound.volume = 1.0; // Max volume
                sound.currentTime = 0; // Reset to start
                sound.play().catch(e => console.log("Audio block: user interact first")); 
            }
        });

        chatRef.on("child_changed", snap => {
            const data = snap.val();
            const msgKey = snap.key;
            
            const msgDiv = document.querySelector(`#msg-${msgKey} .msg`);
            if (msgDiv) {
                msgDiv.dataset.original = data.original;
                msgDiv.dataset.encoded = data.encoded;
                
                const seenSpan = document.getElementById("seen-" + msgKey);
                if (seenSpan) {
                    seenSpan.textContent = `üëÅÔ∏è ${data.views || 0}`;
                }
                
                if (decodeHeld) {
                     updateMessages(true);
                }
            }
        });

        chatRef.on("child_removed", snap => {
            const wrapper = document.getElementById("msg-" + snap.key);
            if (wrapper) wrapper.remove();
        });

        function clearChat() {
            const pass = prompt("Enter admin delete code:");
            if (pass === "1234") {
                chatRef.remove();
                document.getElementById("chatbox").innerHTML = "";
            }
        }

        document.getElementById("upload").onclick = () => document.getElementById("fileInput").click();
        document.getElementById("fileInput").onchange = e => {
            const file = e.target.files[0];
            if (!file || !currentUser) return;
            const filePath = `uploads/${Date.now()}_${file.name}`;
            const uploadTask = storage.ref(filePath).put(file);

            uploadTask.then(snapshot => {
                snapshot.ref.getDownloadURL().then(url => {
                    const isImage = file.type.startsWith("image/");
                    const encoded = "üöÄ üìÅ"; 
                    const original = isImage ? `<img src="${url}" style="max-width:200px;">` : `<a href="${url}" target="_blank">${file.name}</a>`;
                    
                    const now = new Date();
                    const timeString = now.toLocaleDateString() + " " + now.toLocaleTimeString('en-US', {hour: 'numeric', minute:'2-digit', hour12: true});

                    chatRef.push({ name: currentUser, encoded, original, time: timeString, views: 0 });
                    launchRocket();
                });
            }).catch(error => {
                alert("Upload failed: " + error.message);
            });
        };

        function updateMessages(showOriginal) {
            document.querySelectorAll(".msg").forEach(msg => {
                const username = msg.querySelector(".username");
                const timeText = msg.dataset.time || ""; 
                const seenCount = msg.querySelector(".seen-count"); 

                msg.innerHTML = ""; 
                msg.appendChild(username); 
                msg.append(" " + (showOriginal ? msg.dataset.original : msg.dataset.encoded)); 
                
                if(seenCount) msg.appendChild(seenCount);

                const timeSpan = document.createElement("span");
                timeSpan.className = "timestamp";
                timeSpan.textContent = timeText;
                msg.appendChild(timeSpan);
            });
        }

        const decodeBtn = document.getElementById("decodeBtn");
        decodeBtn.onmousedown = decodeBtn.ontouchstart = () => {
            decodeHeld = true;
            updateMessages(true); 
        };

        decodeBtn.onmouseup = decodeBtn.ontouchend = () => {
            decodeHeld = false;
            updateMessages(false); 
        };
    </script>
</body>
</html>
